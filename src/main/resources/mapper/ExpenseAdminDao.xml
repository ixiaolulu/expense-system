<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ExpenseAdminDao">

	<resultMap id="BaseResultMap" type="com.lulu.expense.model.entity.ExpenseAdmin">
		<id property="id" column="id"/>
		<result property="code" column="code"/>
		<result property="password" column="password"/>
		<result property="name" column="name"/>
		<result property="telephone" column="telephone"/>
		<result property="email" column="email"/>
		<result property="enrollDate" column="enrollDate"/>
		<result property="timeCreated" column="timeCreated"/>
		<result property="timeModified" column="timeModified"/>
	</resultMap>

	<sql id="Base_Column_List">
		id,code,password,name,telephone,email,enrollDate,timeCreated,timeModified
	</sql>

	<sql id="Select_Column_List">
		id,code,name,telephone,email,enrollDate,DATE_FORMAT(timeCreated,'%Y-%m-%d %H:%i:%s') as timeCreated,DATE_FORMAT(timeModified,'%Y-%m-%d %H:%i:%s') as timeModified,adminId,roleNameStr
	</sql>

	<insert id="insert" parameterType="com.lulu.expense.model.entity.ExpenseAdmin">
		<selectKey keyProperty="id" order="BEFORE" resultType="int">
			select LAST_INSERT_ID()
		</selectKey>
		INSERT INTO ExpenseAdmin(code,password,telephone,email,enrollDate,timeCreated,timeModified)
		VALUES (#{code},#{password},#{telephone},#{email},#{enrollDate},now(),now())
	</insert>

	<select id="getByCode" parameterType="string" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List"/>
		from ExpenseAdmin where code = #{code}
	</select>

	<!--管理员列表查询列表-->
	<select id="selectListPage" parameterType="HashMap" resultType="HashMap">
		SELECT
		<include refid="Select_Column_List"/>
		FROM
		ExpenseAdmin ea
		LEFT JOIN (
		SELECT
		t1.adminId,
		group_concat(t1.roleName) roleNameStr
		FROM
		(
		SELECT
		adminId,
		NAME AS roleName
		FROM
		ExpenseAdminRole ear
		LEFT JOIN ExpenseRole ar ON ear.roleId = ar.id
		) t1
		GROUP BY
		t1.adminId
		) t2 ON ea.id = t2.adminId
		<where>
			1 = 1
			<if test="roleName != null">
				AND roleNameStr LIKE CONCAT('%',#{roleName},'%')
			</if>
		</where>
		LIMIT #{offset},#{rowsPerPage}

	</select>

	<!--管理员列表查询总数-->
	<select id="selectListPageCount" parameterType="HashMap" resultType="int">
		SELECT COUNT(0)
		FROM
		ExpenseAdmin ea
		LEFT JOIN (
		SELECT
		t1.adminId,
		group_concat(t1.roleName) roleNameStr
		FROM
		(
		SELECT
		adminId,
		NAME AS roleName
		FROM
		ExpenseAdminRole ear
		LEFT JOIN ExpenseRole ar ON ear.roleId = ar.id
		) t1
		GROUP BY
		t1.adminId
		) t2 ON ea.id = t2.adminId
		<where>
			1 = 1
			<if test="roleName != null">
				AND roleNameStr LIKE CONCAT('%',#{roleName},'%')
			</if>
		</where>
    </select>

</mapper>